/*
 * By using this file, you agree to the terms and conditions set
 * forth in the COPYING file which can be found at the top level
 * of this distribution.
 */
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <stdint.h>
#include <fcntl.h>
#include <sys/mman.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <elf.h>

#include "fp.h"
#include "common.c"

char *progname;

void usage(void)
{
	fprintf(stderr,"Usage:\n%s <filename>\n", progname);
	exit(2);
}

int main(int argc, char **argv)
{
	progname = argv[0];
	if (argc < 2)
		usage();

	MMAP_FILE(MODE_READ, argv[1])
	
	FIND_TEXT

	code_t *code = reassemble(m + ehdr->e_entry - text_addr + text_offset);
	
	code_t *c, *prev;
	for (prev = code, c = code->next; c->next != NULL; c = c->next)
		if (c->src[0] != 0xe9 || c->jmpto != c->next->src) {
			printf("Exclude jump at %08x pointing to %08x\n",
				DST2VADDR(c->src), DST2VADDR(c->next->src));
			prev->next = c;
			prev = c;
		}
	prev->next = c;	

	dump_code(code);	

	return 0;
}
